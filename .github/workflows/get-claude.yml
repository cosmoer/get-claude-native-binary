name: Execute Official Claude Installers

on:
  workflow_dispatch: # 手动触发

jobs:
  # ==========================================
  # 任务 1：Linux 环境
  # ==========================================
  install-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Execute install.sh
        # 使用 continue-on-error，因为官方脚本最后一步通常是 'claude login'，
        # 在无交互的 CI 环境中可能会报错退出，但此时文件通常已经下载好了。
        continue-on-error: true
        run: curl -fsSL https://claude.ai/install.sh | sh

      - name: Prepare Artifacts
        run: |
          mkdir -p output/linux
          
          echo "Searching for installed files..."
          
          # 检查官方脚本默认安装目录 ~/.claude
          if [ -d "$HOME/.claude" ]; then
            echo "Found ~/.claude directory, copying..."
            cp -r "$HOME/.claude" output/linux/
          else
            echo "Warning: ~/.claude not found."
          fi
          
          # 检查是否安装到了系统路径 /usr/local/bin
          if [ -f "/usr/local/bin/claude" ]; then
             echo "Found /usr/local/bin/claude, copying..."
             cp /usr/local/bin/claude output/linux/
          fi
          
          ls -R output/

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: claude-install-linux
          path: output/linux/
          if-no-files-found: warn

  # ==========================================
  # 任务 2：Windows 环境
  # ==========================================
  install-windows:
    runs-on: windows-latest
    steps:
      - name: Execute install.ps1
        shell: powershell
        continue-on-error: true
        # 同样忽略可能的登录错误，只为了获取文件
        run: irm https://claude.ai/install.ps1 | iex

      - name: Prepare Artifacts
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path output\windows
          
          Write-Host "Searching for installed files..."
          
          # 检查 Windows 默认安装目录 %APPDATA%\Claude
          $installPath = "$env:APPDATA\Claude"
          
          if (Test-Path $installPath) {
            Write-Host "Found $installPath, copying..."
            Copy-Item -Path $installPath -Destination output\windows -Recurse
          } else {
            Write-Host "Warning: Installation directory not found in APPDATA."
          }

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: claude-install-windows
          path: output/windows/
          if-no-files-found: warn
